version: '3'

services:
  postgres:
    image: postgres

    networks:
      - melody

    ports:
      - 5432:5432

    environment:
      POSTGRES_USER: MelodyUser
      POSTGRES_PASSWORD: MelodyDevelopment
      PGDATA: /var/lib/postgresql/data/pgdata
      POSTGRES_DB: melody

    volumes:
      - ./data:/var/lib/postgresql/data

  redis:
    image: redis

    networks:
      - melody

    ports:
      - 6379:6379

  memcached:
    image: memcached

    networks:
      - melody

    ports:
      - 11211:11211

  services:
    command: bin/development-server
    build: services

    links:
      - postgres
      - redis:redis
      - memcached:memcached

    environment:
      - MELODY_SETTINGS_MODULE=melody.settings.compose

    networks:
      - melody

    ports:
      - 8000:8000

    volumes:
      - './services:/opt/services'

  web:
    command: npm run compose
    build: clients/web

    networks:
      - melody

    ports:
      - 3030:3030

    volumes:
      - './clients/web:/opt/web'

  nginx:
    build: tools/nginx

    links:
      - services
      - web

    networks:
      - melody

    ports:
      - 8080:80

networks:
  melody:
    driver: bridge
