version: '3'

services:
  redis:
    image: redis

    networks:
      - melody

    ports:
      - 6379:6379

  memcached:
    image: memcached

    networks:
      - melody

    ports:
      - 11211:11211

  services:
    command: bin/development-server
    build: services

    links:
      - redis:redis
      - memcached:memcached

    environment:
      - MELODY_SETTINGS_MODULE=melody.settings.compose

    networks:
      - melody

    ports:
      - 8000:8000

    volumes:
      - './services:/opt/services'

  web:
    command: ./node_modules/.bin/nodemon npm start
    build: clients/web

    networks:
      - melody

    ports:
      - 3030:3030

    volumes:
      - './clients/web:/opt/web'

  nginx:
    build: tools/nginx

    links:
      - services
      - web

    networks:
      - melody

    ports:
      - 8080:80

networks:
  melody:
    driver: bridge
